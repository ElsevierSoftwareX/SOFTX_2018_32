var directives=angular.module("json-gui",[]);directives.directive("datetime",function(){return{restrict:"E",templateUrl:"js/directives/datetime/datetime.html",replace:!0,scope:{parameter:"=",dependencies:"="},link:function(e,a,t){e.dependencies;e.validationFunction=new Function(e.parameter.isValid)(),e.parameter.value=new moment(e.parameter.value).toDate(),e.timeValid=function(){return"undefined"==typeof e.parameter.value||"Invalid Date"==e.parameter.value?(e.parameter.message="Select a valid date",!1):(e.parameter.message="",!0)},e.parameter.evaluate=function(){e.parameter.message="";var a=e.validationFunction(e.parameter,e.dependencies);return e.timeValid()?a.valid?(e.parameter.message="",!0):(e.parameter.message=a.message,!1):!1},e.$watch("parameter.message",function(){})}}}),directives.directive("fileupload",["$timeout","Upload",function(e,a){return{restrict:"E",templateUrl:"js/directives/fileupload/fileupload.html",replace:!0,scope:{parameter:"=",dependencies:"="},link:function(a,t,n){a.parameter.dbName,a.dependencies;a.validationFunction=new Function(a.parameter.isValid)(),a.fileuploadValid=function(){return"undefined"==typeof a.parameter.value||a.parameter.value.length<a.parameter.minUpload?(a.parameter.message="Upload at least "+a.parameter.minUpload,a.parameter.message+=1==a.parameter.minUpload?" file":" files",!1):!0},a.parameter.evaluate=function(){a.parameter.message="";var e=a.validationFunction(a.parameter,a.dependencies);return a.fileuploadValid()?e.valid?(a.parameter.message="",!0):(a.parameter.message=e.message,!1):!1},a.initFileReader=function(){window.File&&window.FileList&&window.FileReader&&a.init()},a.init=function(){a.maxLengthByte=r(a.parameter.maxSize);var e=$("#"+a.parameter.dbName),t=e.find("#fileselect")[0],n=e.find("#filedrag")[0],i=e.find("#submitbutton")[0];t.addEventListener("change",a.fileSelectHandler,!1);var s=new XMLHttpRequest;s.upload&&(n.addEventListener("dragover",a.fileDragHover,!1),n.addEventListener("dragleave",a.fileDragHover,!1),n.addEventListener("drop",a.fileSelectHandler,!1),n.style.display="block",i.style.display="none")},a.fileDragHover=function(e){e.stopPropagation(),e.preventDefault(),e.target.className="dragover"==e.type?"hover":""},a.parseFile=function(t){if(t.size>a.maxLengthByte)return void i("The file named "+t.name+" is too big. The maximum dimension accepted is "+a.parameter.maxSize+".");var n=new FileReader;n.onload=function(t){console.log(t.target.result),e(function(){a.parameter.value.push(t.target.result)})},n.readAsDataURL(t),e(function(){a.uploadedFilesDescription.push(t),console.log(a.uploadedFilesDescription)})},a.fileSelectHandler=function(e){a.fileDragHover(e);var t=e.target.files||e.dataTransfer.files;if(a.uploadedFilesDescription.length+t.length>a.parameter.maxUpload)return void i("Reached maximum file uploads allowed ("+a.parameter.maxUpload+").");for(var n,r=0;n=t[r];r++)a.parseFile(n)},a.openInput=function(){$("#"+a.parameter.dbName).find("#fileselect").click()};var r=function(e){e=e.toLowerCase();var a=parseInt(e);return e.indexOf("kb")>0?1e3*a:e.indexOf("mb")>0?1e6*a:e.indexOf("gb")>0?1e9*a:a},i=function(t){e(function(){a.errorUpload.splice(0,0,t)}),e(function(){a.errorUpload.splice(0,1)},5e3)};a.errorUpload=[],a.uploadedFilesDescription=[],e(function(){a.initFileReader()})}}}]),directives.directive("domains",["$timeout",function(e){return{restrict:"E",templateUrl:"js/directives/domains/domains.html",replace:!0,scope:{parameter:"=",dependencies:"="},link:function(a,t,n){var r=a.parameter.dbName;a.dependencies;a.validationFunction=new Function(a.parameter.isValid)(),a.domainsValid=function(){return"undefined"==typeof a.mapRectangles||0===Object.keys(a.mapRectangles).length?(a.parameter.message="Select at least one domain",!1):!0},a.parameter.evaluate=function(){a.parameter.message="";var e=a.validationFunction(a.parameter,a.dependencies);return a.domainsValid()?e.valid?(a.parameter.message="",!0):(a.parameter.message=e.message,!1):!1},a.initializeParameter=function(){var t=2*parseInt($("body").css("width"))/6;console.log($("body").css("width")),a.height=t+"px",a.mapRectangles=[],i(),e(function(){var t=Object.keys(a.parameter.value).length,n=0;for(var i in a.parameter.value){if(n==a.parameter.maxDomains)return void e(function(){a.parameter.value.splice(n,t-n)});var s=d(a.parameter.value[r+n],a.map);if(a.mapRectangles[r+s.zIndex]=s,!p(s.zIndex))break;n++}a.value=a.parameter.value,a.modal=$("#"+a.parameter.dbName+"modal"),a.modal.find(".btn-success").click(function(){l(a.deletingIndex)})},!0)};var i=function(){var e=document.getElementById(a.parameter.dbName+"map"),t={center:new google.maps.LatLng(a.parameter.centerCoords.lat,a.parameter.centerCoords["long"]),zoom:a.parameter.mapZoom,mapTypeId:google.maps.MapTypeId.HYBRID};a.map=new google.maps.Map(e,t),a.rectOptions={strokeColor:"#00BCD4",strokeWeight:1,draggable:!0,fillColor:"#00BCD4",fillOpacity:.5,editable:!0,clickable:!0,zIndex:10,map:a.map},a.drawingManager=new google.maps.drawing.DrawingManager({drawingControl:!0,drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:[google.maps.drawing.OverlayType.RECTANGLE]},rectangleOptions:a.rectOptions}),a.drawingManager.setMap(a.map),google.maps.event.addListener(a.drawingManager,"rectanglecomplete",function(e){var t=a.rectOptions.zIndex+1;return a.rectOptions.zIndex=t,a.drawingManager.setOptions({rectangleOptions:a.rectOptions}),Object.keys(a.mapRectangles).length-1==a.parameter.maxDomains?void e.setMap(null):(e.addListener("bounds_changed",function(){s(e,t)}),e.addListener("click",function(){o(t)}),a.mapRectangles[r+t]=e,m(e,t),void p(t))})},s=function(t,n){var i=t.getBounds();e(function(){var e=a.parameter.value[r+n];"undefined"!=typeof e&&(e.northEast.lat=i.getNorthEast().lat(),e.northEast["long"]=i.getNorthEast().lng(),e.southWest.lat=i.getSouthWest().lat(),e.southWest["long"]=i.getSouthWest().lng(),p(n))})},o=function(e){a.modal.find("#number").html(parseInt(c(r+e))+1),e==Object.keys(a.mapRectangles).length-1?a.modal.find("#lastDomain").css("display","none"):a.modal.find("#lastDomain").css("display","inline"),a.deletingIndex=parseInt(c(r+e)),a.modal.modal("show")},l=function(t){a.modal.modal("hide"),a.parameter.onlyNested?e(function(){var e=t,n=Object.keys(a.mapRectangles),r=n.length-e;console.log("pos: "+e),console.log("howm: "+r);for(var i=0;r>i;i++)a.mapRectangles[n[i+e]].setMap(null),delete a.mapRectangles[n[i+e]],delete a.parameter.value[n[i+e]]},0):e(function(){a.mapRectangles[r+t].setMap(null),delete a.mapRectangles[r+t],delete a.parameter.value[r+t]},0)},p=function(t){if(!a.parameter.onlyNested)return!0;var n=Object.keys(a.mapRectangles),i=a.mapRectangles[r+t],s=i.getBounds(),o=c(r+t);if(o>0){var l=n[o-1],p=a.mapRectangles[l].getBounds();if(s.getSouthWest().lat()<p.getSouthWest().lat()||s.getSouthWest().lat()>p.getNorthEast().lat()||s.getSouthWest().lng()<p.getSouthWest().lng()||s.getSouthWest().lng()>p.getNorthEast().lng()||s.getNorthEast().lat()>p.getNorthEast().lat()||s.getNorthEast().lat()<p.getSouthWest().lat()||s.getNorthEast().lng()>p.getNorthEast().lng()||s.getNorthEast().lng()<p.getSouthWest().lng()){var d=n.length-o;return e(function(){for(var e,t=0;d>t;t++){if(e=t+o,"undefined"==typeof a.mapRectangles[n[e]])return!1;a.mapRectangles[n[e]].setMap(null),delete a.mapRectangles[n[e]],delete a.parameter.value[n[e]]}}),!1}}if(o<n.length-1){var m=a.mapRectangles[n[o+1]].getBounds();if(s.getSouthWest().lat()>m.getSouthWest().lat()||s.getSouthWest().lng()>m.getSouthWest().lng()||s.getNorthEast().lat()<m.getNorthEast().lat()||s.getNorthEast().lng()<m.getNorthEast().lng()){var d=n.length-o-1;return e(function(){for(var e=0;d>e;e++){var t=e+o+1;if("undefined"==typeof a.mapRectangles[n[t]])return;a.mapRectangles[n[t]].setMap(null),delete a.mapRectangles[n[t]],delete a.parameter.value[n[t]]}}),!1}}return!0},d=function(e,t){var n=new google.maps.Rectangle({strokeColor:"#00BCD4",strokeWeight:1,draggable:!0,fillColor:"#00BCD4",fillOpacity:.5,editable:!0,clickable:!0,zIndex:Object.keys(a.mapRectangles).length,map:t,bounds:{north:e.northEast.lat,south:e.southWest.lat,east:e.northEast["long"],west:e.southWest["long"]}}),r=Object.keys(a.mapRectangles).length;return n.addListener("bounds_changed",function(){s(n,r)}),n.addListener("click",function(){o(r)}),n},m=function(t,n){var i=t.getBounds().getSouthWest(),s=t.getBounds().getNorthEast(),o={southWest:{lat:i.lat(),"long":i.lng()},northEast:{lat:s.lat(),"long":s.lng()}};e(function(){a.parameter.value[r+n]=o})},c=function(e){for(var t=Object.keys(a.mapRectangles),n=0;n<t.length;n++)if(t[n]===e)return n};a.range=function(){return Object.keys(a.parameter.value)},e(function(){google.maps.event.addDomListener(window,"load",a.initializeParameter())}),a.$watch("parameter.message",function(){})}}}]),directives.directive("integer",function(){return{restrict:"E",templateUrl:"js/directives/integer/integer.html",replace:!0,scope:{parameter:"=",dependencies:"="},link:function(e,a,t){e.dependencies;e.validationFunction=new Function(e.parameter.isValid)(),e.integerValid=function(){return e.parameter.value%1!==0||"NaN"===e.parameter.value?(e.parameter.message="Number is not an Integer",!1):(e.parameter.message="",!0)},e.parameter.evaluate=function(){e.parameter.message="";var a=e.validationFunction(e.parameter,e.dependencies);return e.integerValid()?a.valid?(e.parameter.message="",!0):(e.parameter.message=a.message,!1):!1},e.$watch("parameter.message",function(){})}}}),directives.directive("float",function(){return{restrict:"E",templateUrl:"js/directives/float/float.html",replace:!0,scope:{parameter:"=",dependencies:"="},link:function(e,a,t){e.dependencies;e.validationFunction=new Function(e.parameter.isValid)(),e.floatValid=function(){return"undefined"==typeof e.parameter.value||"NaN"===e.parameter.value?(e.parameter.message="Number format is not valid",!1):(e.parameter.message="",!0)},e.parameter.evaluate=function(){e.parameter.message="";var a=e.validationFunction(e.parameter,e.dependencies);return e.floatValid()?a.valid?(e.parameter.message="",!0):(e.parameter.message=a.message,!1):!1},e.$watch("parameter.message",function(){})}}}),directives.directive("jsonGui",["$timeout",function($timeout){return{restrict:"E",templateUrl:"js/directives/json-gui/json-gui.html",replace:!0,scope:{data:"="},link:function(scope,elm,attr){scope.pars=[],scope.dep=[],scope.buildParametersArray=function(){var e=scope.data.parameters;for(var a in e)scope.pars[e[a].dbName]=e[a]},$timeout(function(){$("#nav").affix({offset:{}}),$("body").scrollspy({target:"#scrollspy"})}),scope.buildDependencies=function(){var e;for(var a in scope.pars){var t={};e=scope.pars[a].dependenciesNames;for(var n=0;n<e.length;n++)t[e[n]]=scope.pars[e[n]];scope.dep[a]=t}},scope.saveConfiguration=function(){var namelist="";for(var par in scope.pars){if(console.log(scope.pars[par]),!scope.pars[par].evaluate())return void console.log("Error in some parameter");namelist+=scope.pars[par].displayName+": "+eval(scope.pars[par].computedResult)+";\n"}console.log(namelist)},scope.hashToArray=function(e){var a=[],t=0;for(item in e)a[t]=item,t++;return a},scope.buildParametersArray(),scope.buildDependencies()}}}]),directives.directive("selectParameter",function(){return{restrict:"E",templateUrl:"js/directives/select/select.html",replace:!0,scope:{parameter:"=",dependencies:"="},link:function(e,a,t){e.dependencies;e.validationFunction=new Function(e.parameter.isValid)(),e.selectValid=function(){return!0},e.parameter.evaluate=function(){e.parameter.message="";var a=e.validationFunction(e.parameter,e.dependencies);return e.selectValid()?a.valid?(e.parameter.message="",!0):(e.parameter.message=a.message,!1):!1},e.$watch("parameter.message",function(){})}}}),directives.directive("textParameter",function(){return{restrict:"E",templateUrl:"js/directives/text/text.html",replace:!0,scope:{parameter:"=",dependencies:"="},link:function(e,a,t){e.dependencies;e.validationFunction=new Function(e.parameter.isValid)(),e.textValid=function(){return""===e.parameter.value?(e.parameter.message="Insert some text",!1):(e.parameter.message="",!0)},e.parameter.evaluate=function(){e.parameter.message="";var a=e.validationFunction(e.parameter,e.dependencies);return e.textValid()?a.valid?(e.parameter.message="",!0):(e.parameter.message=a.message,!1):!1},e.$watch("parameter.message",function(){})}}});